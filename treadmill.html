<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Scale Treadmill - Bass Trainer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #0a1a1a 0%, #0a2a2a 100%);
      min-height: 100vh;
      color: #fff;
      font-family: 'Syne Mono', monospace;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      height: 100vh;
    }
    
    /* Side Panel */
    .side-panel {
      width: 280px;
      background: rgba(0,0,0,0.6);
      border-right: 2px solid rgba(0,255,204,0.3);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .back-link {
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 0.85rem;
    }
    .back-link:hover { color: #0fc; }
    
    .panel-title {
      font-size: 1.1rem;
      color: #0fc;
      text-shadow: 0 0 10px rgba(0,255,204,0.5);
    }
    
    .setting-group {
      background: rgba(0,255,204,0.05);
      border: 1px solid rgba(0,255,204,0.2);
      border-radius: 10px;
      padding: 15px;
    }
    
    .setting-group label {
      display: block;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .setting-group select,
    .setting-group input[type="number"] {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(0,255,204,0.3);
      border-radius: 6px;
      color: #0fc;
      font-family: 'Syne Mono', monospace;
      font-size: 1rem;
    }
    
    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: #0fc;
      box-shadow: 0 0 10px rgba(0,255,204,0.3);
    }
    
    .btn {
      padding: 15px 20px;
      font-family: 'Syne Mono', monospace;
      font-size: 1rem;
      border: 2px solid #0fc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }
    
    .btn-start {
      background: rgba(0,255,204,0.2);
      color: #0fc;
    }
    .btn-start:hover {
      background: #0fc;
      color: #000;
      box-shadow: 0 0 20px rgba(0,255,204,0.5);
    }
    
    .btn-pause {
      background: rgba(255,200,0,0.2);
      color: #fc0;
      border-color: #fc0;
    }
    .btn-pause:hover {
      background: #fc0;
      color: #000;
    }
    
    .btn-stop {
      background: rgba(255,0,0,0.2);
      color: #f66;
      border-color: #f66;
    }
    .btn-stop:hover {
      background: #f66;
      color: #000;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
    }
    
    .live-stats {
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85rem;
    }
    
    .live-stats div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .live-stats div:last-child { margin-bottom: 0; }
    
    .stat-label { color: rgba(255,255,255,0.5); }
    .stat-value { color: #0fc; }
    .stat-value.good { color: #0f8; }
    .stat-value.bad { color: #f66; }
    
    /* Main Area */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .track-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    canvas {
      width: 100%;
      height: 100%;
    }
    
    /* Pause Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .modal-overlay.visible {
      display: flex;
    }
    
    .modal {
      background: linear-gradient(135deg, #1a2a2a, #0a1a1a);
      border: 2px solid #0fc;
      border-radius: 20px;
      padding: 40px;
      min-width: 350px;
      text-align: center;
      box-shadow: 0 0 60px rgba(0,255,204,0.3);
    }
    
    .modal h2 {
      font-size: 2rem;
      color: #fc0;
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(255,200,0,0.5);
    }
    
    .modal-stats {
      text-align: left;
      margin-bottom: 30px;
    }
    
    .modal-stats div {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 1.1rem;
    }
    
    .modal-stats .label { color: rgba(255,255,255,0.6); }
    .modal-stats .value { color: #0fc; font-weight: bold; }
    .modal-stats .value.good { color: #0f8; }
    .modal-stats .value.bad { color: #f66; }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .modal .btn {
      min-width: 120px;
    }

    /* Detected note display */
    .detected-note {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      color: #0fc;
      text-shadow: 0 0 20px rgba(0,255,204,0.8);
      background: rgba(0,0,0,0.6);
      padding: 10px 30px;
      border-radius: 10px;
      border: 1px solid rgba(0,255,204,0.3);
    }
    
    .detected-note.hit { color: #0f8; border-color: #0f8; }
    .detected-note.miss { color: #f66; border-color: #f66; }

    @media (max-width: 700px) {
      .app { flex-direction: column; }
      .side-panel {
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        border-right: none;
        border-bottom: 2px solid rgba(0,255,204,0.3);
      }
      .setting-group { flex: 1; min-width: 140px; }
      .controls { flex-direction: row; flex-wrap: wrap; }
      .controls .btn { flex: 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="side-panel">
      <div class="panel-header">
        <a href="index.html" class="back-link">← Back</a>
        <span class="panel-title">TREADMILL</span>
      </div>
      
      <div class="setting-group">
        <label>Root Note</label>
        <select id="root-note">
          <option value="0">C</option>
          <option value="1">C# / Db</option>
          <option value="2">D</option>
          <option value="3">D# / Eb</option>
          <option value="4" selected>E</option>
          <option value="5">F</option>
          <option value="6">F# / Gb</option>
          <option value="7">G</option>
          <option value="8">G# / Ab</option>
          <option value="9">A</option>
          <option value="10">A# / Bb</option>
          <option value="11">B</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>Scale / Mode</label>
        <select id="scale-type">
          <option value="major">Major (Ionian)</option>
          <option value="minor">Natural Minor (Aeolian)</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="pentatonic-major">Pentatonic Major</option>
          <option value="pentatonic-minor" selected>Pentatonic Minor</option>
          <option value="blues">Blues</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>Starting BPM</label>
        <input type="number" id="start-bpm" value="60" min="30" max="200">
      </div>
      
      <div class="setting-group">
        <label>Acceleration (BPM/min)</label>
        <input type="number" id="acceleration" value="0" min="0" max="30" step="1">
        <small style="color: rgba(255,255,255,0.4); font-size: 0.7rem;">0 = constant speed</small>
      </div>
      
      <div class="live-stats">
        <div><span class="stat-label">Current BPM</span><span class="stat-value" id="current-bpm">60</span></div>
        <div><span class="stat-label">Hits</span><span class="stat-value good" id="hits">0</span></div>
        <div><span class="stat-label">Misses</span><span class="stat-value bad" id="misses">0</span></div>
        <div><span class="stat-label">Accuracy</span><span class="stat-value" id="accuracy">--%</span></div>
      </div>
      
      <div class="controls">
        <button class="btn btn-start" id="start-btn">▶ Start</button>
        <button class="btn btn-pause" id="pause-btn" style="display:none;">⏸ Pause</button>
        <button class="btn btn-stop" id="stop-btn" style="display:none;">⏹ Stop</button>
      </div>
    </div>
    
    <div class="main-area">
      <div class="track-container">
        <canvas id="track"></canvas>
      </div>
      <div class="detected-note" id="detected-note">--</div>
    </div>
  </div>
  
  <div class="modal-overlay" id="pause-modal">
    <div class="modal">
      <h2>PAUSED</h2>
      <div class="modal-stats">
        <div><span class="label">Time Elapsed</span><span class="value" id="modal-time">0:00</span></div>
        <div><span class="label">Notes Played</span><span class="value" id="modal-total">0</span></div>
        <div><span class="label">Hits</span><span class="value good" id="modal-hits">0</span></div>
        <div><span class="label">Misses</span><span class="value bad" id="modal-misses">0</span></div>
        <div><span class="label">Accuracy</span><span class="value" id="modal-accuracy">--%</span></div>
        <div><span class="label">Current BPM</span><span class="value" id="modal-bpm">60</span></div>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-start" id="resume-btn">▶ Resume</button>
        <button class="btn btn-stop" id="end-btn">⏹ End</button>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    
    // Note names
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    // Scale intervals
    const SCALES = {
      'major': [0, 2, 4, 5, 7, 9, 11],
      'minor': [0, 2, 3, 5, 7, 8, 10],
      'dorian': [0, 2, 3, 5, 7, 9, 10],
      'phrygian': [0, 1, 3, 5, 7, 8, 10],
      'lydian': [0, 2, 4, 6, 7, 9, 11],
      'mixolydian': [0, 2, 4, 5, 7, 9, 10],
      'locrian': [0, 1, 3, 5, 6, 8, 10],
      'pentatonic-major': [0, 2, 4, 7, 9],
      'pentatonic-minor': [0, 3, 5, 7, 10],
      'blues': [0, 3, 5, 6, 7, 10]
    };
    
    // State
    let state = {
      running: false,
      paused: false,
      startTime: 0,
      pausedTime: 0,
      bpm: 60,
      baseBpm: 60,
      acceleration: 0,
      rootNote: 4,
      scaleType: 'pentatonic-minor',
      notes: [],
      hits: 0,
      misses: 0,
      lastNoteTime: 0,
      scaleNotes: [],
      currentScaleIndex: 0
    };
    
    // Canvas
    const canvas = $('track');
    const ctx = canvas.getContext('2d');
    
    // Hit line position (percentage from left)
    const HIT_LINE_X = 0.15;
    const NOTE_RADIUS = 35;
    const HIT_WINDOW = 80; // pixels
    
    // Microphone
    let audioCtx, analyser, micStream;
    let lastDetectedNote = null;
    let noteHeld = false;
    
    function resize() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    
    function getScaleNotes() {
      const root = state.rootNote;
      const intervals = SCALES[state.scaleType];
      const notes = [];
      // Generate 2 octaves
      for (let oct = 0; oct < 2; oct++) {
        for (const interval of intervals) {
          notes.push({
            midi: 40 + root + interval + (oct * 12), // Bass range starting E1
            name: NOTE_NAMES[(root + interval) % 12]
          });
        }
      }
      return notes;
    }
    
    function spawnNote() {
      const scaleNote = state.scaleNotes[state.currentScaleIndex];
      state.currentScaleIndex = (state.currentScaleIndex + 1) % state.scaleNotes.length;
      
      state.notes.push({
        x: canvas.offsetWidth + NOTE_RADIUS,
        name: scaleNote.name,
        midi: scaleNote.midi,
        hit: null, // null = pending, true = hit, false = miss
        scored: false
      });
    }
    
    function updateBpm(elapsed) {
      if (state.acceleration > 0) {
        const minutesElapsed = elapsed / 60000;
        state.bpm = Math.min(200, state.baseBpm + (state.acceleration * minutesElapsed));
      }
      $('current-bpm').textContent = Math.round(state.bpm);
    }
    
    function updateStats() {
      $('hits').textContent = state.hits;
      $('misses').textContent = state.misses;
      const total = state.hits + state.misses;
      const acc = total > 0 ? Math.round((state.hits / total) * 100) : 0;
      $('accuracy').textContent = total > 0 ? acc + '%' : '--%';
    }
    
    // Pitch detection
    function detectPitch(buffer, sampleRate) {
      const SIZE = buffer.length;
      let rms = 0;
      for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) return null;
      
      let bestCorrelation = 0, bestOffset = -1;
      for (let offset = 50; offset < SIZE / 2; offset++) {
        let correlation = 0;
        for (let i = 0; i < SIZE / 2; i++) {
          correlation += Math.abs(buffer[i] - buffer[i + offset]);
        }
        correlation = 1 - correlation / (SIZE / 2);
        if (correlation > bestCorrelation) {
          bestCorrelation = correlation;
          bestOffset = offset;
        }
      }
      
      if (bestCorrelation > 0.9 && bestOffset > 0) {
        return sampleRate / bestOffset;
      }
      return null;
    }
    
    function freqToMidi(freq) {
      return Math.round(12 * Math.log2(freq / 440) + 69);
    }
    
    function midiToName(midi) {
      return NOTE_NAMES[midi % 12];
    }
    
    function processMic() {
      if (!analyser || !state.running || state.paused) {
        requestAnimationFrame(processMic);
        return;
      }
      
      const buffer = new Float32Array(analyser.fftSize);
      analyser.getFloatTimeDomainData(buffer);
      const freq = detectPitch(buffer, audioCtx.sampleRate);
      
      if (freq && freq > 30 && freq < 500) {
        const midi = freqToMidi(freq);
        const noteName = midiToName(midi);
        
        $('detected-note').textContent = noteName;
        $('detected-note').className = 'detected-note';
        
        if (noteName !== lastDetectedNote) {
          lastDetectedNote = noteName;
          noteHeld = false;
        }
        
        // Check for hits
        if (!noteHeld) {
          const hitLineX = canvas.offsetWidth * HIT_LINE_X;
          for (const note of state.notes) {
            if (note.hit === null && !note.scored) {
              const dist = Math.abs(note.x - hitLineX);
              if (dist < HIT_WINDOW && note.name === noteName) {
                note.hit = true;
                note.scored = true;
                state.hits++;
                noteHeld = true;
                $('detected-note').className = 'detected-note hit';
                updateStats();
                break;
              }
            }
          }
        }
      } else {
        lastDetectedNote = null;
        noteHeld = false;
      }
      
      requestAnimationFrame(processMic);
    }
    
    async function initMic() {
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        const source = audioCtx.createMediaStreamSource(micStream);
        source.connect(analyser);
        processMic();
        return true;
      } catch (e) {
        alert('Microphone access required for pitch detection');
        return false;
      }
    }
    
    function update(dt, now) {
      const hitLineX = canvas.offsetWidth * HIT_LINE_X;
      const speed = (state.bpm / 60) * 150; // pixels per second based on BPM
      
      // Move notes
      for (const note of state.notes) {
        note.x -= speed * (dt / 1000);
        
        // Mark as miss if passed hit line without being hit
        if (note.hit === null && note.x < hitLineX - HIT_WINDOW) {
          note.hit = false;
          note.scored = true;
          state.misses++;
          updateStats();
        }
      }
      
      // Remove notes that left the screen
      state.notes = state.notes.filter(n => n.x > -NOTE_RADIUS * 2);
      
      // Spawn new notes
      const beatInterval = 60000 / state.bpm;
      if (now - state.lastNoteTime > beatInterval) {
        spawnNote();
        state.lastNoteTime = now;
      }
    }
    
    function render() {
      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      
      // Clear
      ctx.fillStyle = '#0a1a1a';
      ctx.fillRect(0, 0, w, h);
      
      // Grid lines
      ctx.strokeStyle = 'rgba(0,255,204,0.1)';
      ctx.lineWidth = 1;
      for (let x = 0; x < w; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }
      
      // Hit line
      const hitLineX = w * HIT_LINE_X;
      ctx.strokeStyle = '#0fc';
      ctx.lineWidth = 4;
      ctx.shadowColor = '#0fc';
      ctx.shadowBlur = 20;
      ctx.beginPath();
      ctx.moveTo(hitLineX, 0);
      ctx.lineTo(hitLineX, h);
      ctx.stroke();
      ctx.shadowBlur = 0;
      
      // Hit zone indicator
      ctx.fillStyle = 'rgba(0,255,204,0.1)';
      ctx.fillRect(hitLineX - HIT_WINDOW, 0, HIT_WINDOW * 2, h);
      
      // Notes
      const centerY = h / 2;
      for (const note of state.notes) {
        ctx.save();
        ctx.translate(note.x, centerY);
        
        // Circle
        ctx.beginPath();
        ctx.arc(0, 0, NOTE_RADIUS, 0, Math.PI * 2);
        
        if (note.hit === true) {
          // Hit - green fill
          ctx.fillStyle = 'rgba(0,255,100,0.8)';
          ctx.strokeStyle = '#0f8';
          ctx.shadowColor = '#0f8';
          ctx.shadowBlur = 20;
        } else if (note.hit === false) {
          // Miss - red fill
          ctx.fillStyle = 'rgba(255,50,50,0.8)';
          ctx.strokeStyle = '#f55';
          ctx.shadowColor = '#f55';
          ctx.shadowBlur = 20;
        } else {
          // Pending
          ctx.fillStyle = 'rgba(0,0,0,0.6)';
          ctx.strokeStyle = '#0fc';
          ctx.shadowColor = '#0fc';
          ctx.shadowBlur = 10;
        }
        
        ctx.fill();
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.shadowBlur = 0;
        
        // Note name
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 24px "Syne Mono"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(note.name, 0, 0);
        
        ctx.restore();
      }
      
      // Scale info
      ctx.fillStyle = 'rgba(255,255,255,0.4)';
      ctx.font = '14px "Syne Mono"';
      ctx.textAlign = 'right';
      const rootName = NOTE_NAMES[state.rootNote];
      const scaleName = $('scale-type').selectedOptions[0].text;
      ctx.fillText(`${rootName} ${scaleName}`, w - 20, 30);
    }
    
    let lastTime = 0;
    function loop(time) {
      if (!state.running) return;
      
      if (state.paused) {
        requestAnimationFrame(loop);
        return;
      }
      
      const dt = lastTime ? time - lastTime : 16;
      lastTime = time;
      
      const elapsed = time - state.startTime - state.pausedTime;
      updateBpm(elapsed);
      update(dt, time);
      render();
      
      requestAnimationFrame(loop);
    }
    
    async function start() {
      if (!audioCtx) {
        const ok = await initMic();
        if (!ok) return;
      }
      
      state.running = true;
      state.paused = false;
      state.startTime = performance.now();
      state.pausedTime = 0;
      state.baseBpm = parseInt($('start-bpm').value) || 60;
      state.bpm = state.baseBpm;
      state.acceleration = parseFloat($('acceleration').value) || 0;
      state.rootNote = parseInt($('root-note').value);
      state.scaleType = $('scale-type').value;
      state.scaleNotes = getScaleNotes();
      state.currentScaleIndex = 0;
      state.notes = [];
      state.hits = 0;
      state.misses = 0;
      state.lastNoteTime = 0;
      lastTime = 0;
      
      updateStats();
      
      $('start-btn').style.display = 'none';
      $('pause-btn').style.display = 'block';
      $('stop-btn').style.display = 'block';
      
      // Disable settings while running
      $('root-note').disabled = true;
      $('scale-type').disabled = true;
      $('start-bpm').disabled = true;
      $('acceleration').disabled = true;
      
      requestAnimationFrame(loop);
    }
    
    let pauseStart = 0;
    function pause() {
      state.paused = true;
      pauseStart = performance.now();
      
      // Update modal stats
      const elapsed = performance.now() - state.startTime - state.pausedTime;
      const mins = Math.floor(elapsed / 60000);
      const secs = Math.floor((elapsed % 60000) / 1000);
      $('modal-time').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      $('modal-total').textContent = state.hits + state.misses;
      $('modal-hits').textContent = state.hits;
      $('modal-misses').textContent = state.misses;
      const total = state.hits + state.misses;
      $('modal-accuracy').textContent = total > 0 ? Math.round((state.hits / total) * 100) + '%' : '--%';
      $('modal-bpm').textContent = Math.round(state.bpm);
      
      $('pause-modal').classList.add('visible');
    }
    
    function resume() {
      state.pausedTime += performance.now() - pauseStart;
      state.paused = false;
      $('pause-modal').classList.remove('visible');
    }
    
    function stop() {
      state.running = false;
      state.paused = false;
      state.notes = [];
      
      $('pause-modal').classList.remove('visible');
      $('start-btn').style.display = 'block';
      $('pause-btn').style.display = 'none';
      $('stop-btn').style.display = 'none';
      
      // Re-enable settings
      $('root-note').disabled = false;
      $('scale-type').disabled = false;
      $('start-bpm').disabled = false;
      $('acceleration').disabled = false;
      
      render();
    }
    
    // Event listeners
    $('start-btn').addEventListener('click', start);
    $('pause-btn').addEventListener('click', pause);
    $('stop-btn').addEventListener('click', stop);
    $('resume-btn').addEventListener('click', resume);
    $('end-btn').addEventListener('click', stop);
    
    window.addEventListener('keydown', e => {
      if (e.code === 'Space' && state.running) {
        e.preventDefault();
        state.paused ? resume() : pause();
      }
    });
    
    window.addEventListener('resize', resize);
    resize();
    render();
  </script>
</body>
</html>
