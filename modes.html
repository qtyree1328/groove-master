<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>MODES - Chord Progressions</title>
  <meta name="description" content="Practice diatonic chord triads in any key">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a2a 100%);
      min-height: 100vh;
      color: #fff;
      font-family: 'Syne Mono', monospace;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    
    .back-btn {
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }
    
    .back-btn:hover { color: #ff00aa; }
    
    h1 {
      font-size: 1.5rem;
      background: linear-gradient(135deg, #00ffcc, #ff00aa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .midi-status {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
    }
    
    .midi-status.connected { color: #00ff66; }
    
    /* Key Selection */
    .key-select {
      text-align: center;
      padding: 60px 20px;
    }
    
    .key-select h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #00ffcc;
    }
    
    .key-select p {
      color: rgba(255,255,255,0.6);
      margin-bottom: 30px;
    }
    
    .key-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .key-btn {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 18px;
      font-size: 1.3rem;
      color: #00ffcc;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .key-btn:hover {
      background: rgba(0,255,204,0.1);
      border-color: #00ffcc;
      transform: scale(1.05);
    }
    
    /* Game Screen */
    .game-screen { display: none; }
    .game-screen.active { display: block; }
    
    /* Progress bar */
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .chord-pip {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.4);
      transition: all 0.3s;
    }
    
    .chord-pip.complete {
      background: #00ff66;
      color: #000;
    }
    
    .chord-pip.current {
      background: #ff00aa;
      color: #fff;
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255,0,170,0.5);
    }
    
    /* Current chord display */
    .chord-display {
      text-align: center;
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .chord-label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.5);
      margin-bottom: 10px;
    }
    
    .chord-name {
      font-size: 4rem;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .chord-name .root { color: #fff; }
    .chord-name .quality { color: #ff00aa; }
    
    .note-pills {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .note-pill {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 1.4rem;
      font-weight: bold;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(0,255,204,0.3);
      color: #00ffcc;
      transition: all 0.2s;
    }
    
    .note-pill.played {
      background: #00ff66;
      border-color: #00ff66;
      color: #000;
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(0,255,102,0.5);
    }
    
    .progress-text {
      color: rgba(255,255,255,0.5);
      font-size: 0.9rem;
    }
    
    /* Fretboard */
    .fretboard-container {
      overflow-x: auto;
      padding: 10px 0 20px;
      margin-bottom: 20px;
    }
    
    .fretboard {
      background: linear-gradient(180deg, #3d2817 0%, #2a1a0f 100%);
      border-radius: 12px;
      padding: 20px;
      min-width: 1000px;
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    .fret-row {
      display: flex;
      align-items: center;
      height: 40px;
      position: relative;
    }
    
    .string-label {
      width: 30px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      font-weight: bold;
    }
    
    .frets {
      display: flex;
      flex: 1;
      position: relative;
    }
    
    .fret {
      width: 60px;
      height: 100%;
      border-right: 2px solid #888;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .fret:first-child {
      border-right: 4px solid #f5f5dc;
      width: 30px;
    }
    
    .string-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ccc, #888);
      top: 50%;
      transform: translateY(-50%);
    }
    
    .fret-row:nth-child(1) .string-line { height: 4px; background: #ddd; }
    .fret-row:nth-child(2) .string-line { height: 3.5px; }
    .fret-row:nth-child(3) .string-line { height: 3px; background: #aaa; }
    .fret-row:nth-child(4) .string-line { height: 2.5px; background: #999; }
    
    .note-marker {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      position: relative;
      z-index: 10;
      transition: all 0.2s;
    }
    
    .note-marker.root { background: #ff6b6b; color: #000; }
    .note-marker.third { background: #4ecdc4; color: #000; }
    .note-marker.fifth { background: #45b7d1; color: #000; }
    
    .note-marker.played {
      background: #00ff66 !important;
      box-shadow: 0 0 15px #00ff66;
      transform: scale(1.2);
    }
    
    .fret-numbers {
      display: flex;
      padding-left: 30px;
      margin-top: 10px;
    }
    
    .fret-num {
      width: 60px;
      text-align: center;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
    }
    
    .fret-num:first-child { width: 30px; }
    
    .fret-markers {
      display: flex;
      padding-left: 30px;
      margin-top: 5px;
    }
    
    .fret-marker-dot {
      width: 60px;
      display: flex;
      justify-content: center;
    }
    
    .fret-marker-dot:first-child { width: 30px; }
    
    .fret-marker-dot span {
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
    }
    
    .fret-marker-dot.twelve span {
      width: 10px;
      height: 10px;
    }
    
    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .control-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 12px 24px;
      color: rgba(255,255,255,0.8);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
    }
    
    .control-btn.primary {
      background: linear-gradient(135deg, #ff00aa, #ff8800);
      border: none;
      color: #fff;
    }
    
    .control-btn.primary:hover {
      transform: scale(1.05);
    }
    
    /* Toggle */
    .toggle-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
    }
    
    .toggle-row input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Complete screen */
    .complete-screen {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }
    
    .complete-screen.active { display: block; }
    
    .complete-screen h2 {
      font-size: 3rem;
      color: #00ff66;
      margin-bottom: 20px;
    }
    
    .complete-screen p {
      color: rgba(255,255,255,0.7);
      font-size: 1.2rem;
      margin-bottom: 30px;
    }
    
    .complete-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    
    /* Keyboard hint */
    .keyboard-hint {
      text-align: center;
      color: rgba(255,255,255,0.3);
      font-size: 0.75rem;
      margin-top: 20px;
    }
    
    /* Hidden */
    .hidden { display: none !important; }
  </style>
  <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="back-btn">‚Üê Back</a>
      <h1>üéµ MODES</h1>
      <span id="midiStatus" class="midi-status">No MIDI</span>
    </header>

    <!-- Key Selection -->
    <div id="keySelect" class="key-select">
      <h2>Choose a Key</h2>
      <p>Practice the 7 diatonic chord triads</p>
      <div class="key-grid" id="keyGrid"></div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="game-screen">
      <!-- Progress bar -->
      <div class="progress-bar" id="progressBar"></div>

      <!-- Current chord -->
      <div class="chord-display">
        <p class="chord-label">Play this chord:</p>
        <h2 class="chord-name">
          <span class="root" id="chordRoot">D</span><span class="quality" id="chordQuality">maj</span>
        </h2>
        <div class="note-pills" id="notePills"></div>
        <p class="progress-text"><span id="playedCount">0</span>/3 notes played</p>
      </div>

      <!-- Fretboard -->
      <div class="fretboard-container">
        <div class="fretboard" id="fretboard"></div>
      </div>

      <!-- Toggle -->
      <div class="toggle-row">
        <input type="checkbox" id="showAllPositions" checked>
        <label for="showAllPositions">Show all fret positions</label>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="control-btn" onclick="changeKey()">Change Key</button>
        <button class="control-btn" onclick="resetGame()">Restart</button>
      </div>

      <p class="keyboard-hint" id="keyboardHint">
        No MIDI detected. Keyboard: A=C, W=C#, S=D, E=D#, D=E, F=F, T=F#, G=G, Y=G#, H=A, U=A#, J=B
      </p>
    </div>

    <!-- Complete Screen -->
    <div id="completeScreen" class="complete-screen">
      <h2>üéâ COMPLETE!</h2>
      <p>You played all 7 chords in <span id="completedKey">D</span> major!</p>
      <div class="complete-buttons">
        <button class="control-btn primary" onclick="resetGame()">Play Again</button>
        <button class="control-btn" onclick="changeKey()">New Key</button>
      </div>
    </div>
  </div>

  <script>
    // Music theory
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const MAJOR_SCALE_INTERVALS = [0, 2, 4, 5, 7, 9, 11];
    const SCALE_CHORD_QUALITIES = ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'];
    const CHORD_INTERVALS = {
      'maj': [0, 4, 7],
      'min': [0, 3, 7],
      'dim': [0, 3, 6]
    };
    const BASS_OPEN_STRINGS = [28, 33, 38, 43]; // E1, A1, D2, G2
    const STRING_NAMES = ['E', 'A', 'D', 'G'];
    const FRET_COUNT = 15;

    // State
    let selectedKey = null;
    let currentChordIndex = 0;
    let playedNotes = new Set();
    let chords = [];
    let midiAccess = null;

    // DOM elements
    const keySelect = document.getElementById('keySelect');
    const gameScreen = document.getElementById('gameScreen');
    const completeScreen = document.getElementById('completeScreen');
    const keyGrid = document.getElementById('keyGrid');
    const progressBar = document.getElementById('progressBar');
    const chordRoot = document.getElementById('chordRoot');
    const chordQuality = document.getElementById('chordQuality');
    const notePills = document.getElementById('notePills');
    const playedCount = document.getElementById('playedCount');
    const fretboard = document.getElementById('fretboard');
    const midiStatus = document.getElementById('midiStatus');
    const keyboardHint = document.getElementById('keyboardHint');
    const completedKey = document.getElementById('completedKey');
    const showAllPositions = document.getElementById('showAllPositions');

    // Initialize
    function init() {
      // Build key grid
      NOTE_NAMES.forEach(note => {
        const btn = document.createElement('button');
        btn.className = 'key-btn';
        btn.textContent = note;
        btn.onclick = () => selectKey(note);
        keyGrid.appendChild(btn);
      });

      // MIDI setup
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(access => {
          midiAccess = access;
          midiStatus.textContent = 'üé∏ MIDI Ready';
          midiStatus.classList.add('connected');
          keyboardHint.classList.add('hidden');
          
          access.inputs.forEach(input => {
            input.onmidimessage = handleMIDI;
          });
          
          access.onstatechange = () => {
            access.inputs.forEach(input => {
              input.onmidimessage = handleMIDI;
            });
          };
        }).catch(() => {
          midiStatus.textContent = 'No MIDI';
        });
      }

      // Keyboard fallback
      window.addEventListener('keydown', handleKeyboard);
      
      // Toggle listener
      showAllPositions.addEventListener('change', renderFretboard);
    }

    function getNoteIndex(name) {
      return NOTE_NAMES.indexOf(name.replace(/[0-9]/g, ''));
    }

    function getNoteName(midiNote) {
      return NOTE_NAMES[midiNote % 12];
    }

    function getMajorScaleNotes(root) {
      const rootIdx = getNoteIndex(root);
      return MAJOR_SCALE_INTERVALS.map(i => NOTE_NAMES[(rootIdx + i) % 12]);
    }

    function getChordNotes(root, quality) {
      const rootIdx = getNoteIndex(root);
      const intervals = CHORD_INTERVALS[quality];
      return intervals.map(i => NOTE_NAMES[(rootIdx + i) % 12]);
    }

    function getScaleChords(root) {
      const scaleNotes = getMajorScaleNotes(root);
      return scaleNotes.map((note, i) => ({
        root: note,
        quality: SCALE_CHORD_QUALITIES[i],
        notes: getChordNotes(note, SCALE_CHORD_QUALITIES[i])
      }));
    }

    function getNotePositions(noteName) {
      const positions = [];
      const noteIdx = getNoteIndex(noteName);
      BASS_OPEN_STRINGS.forEach((open, string) => {
        for (let fret = 0; fret <= FRET_COUNT; fret++) {
          if ((open + fret) % 12 === noteIdx) {
            positions.push({ string, fret });
          }
        }
      });
      return positions;
    }

    function selectKey(key) {
      selectedKey = key;
      chords = getScaleChords(key);
      currentChordIndex = 0;
      playedNotes.clear();
      
      keySelect.classList.remove('active');
      keySelect.style.display = 'none';
      completeScreen.classList.remove('active');
      gameScreen.classList.add('active');
      
      renderProgress();
      renderChord();
      renderFretboard();
    }

    function renderProgress() {
      progressBar.innerHTML = '';
      chords.forEach((chord, i) => {
        const pip = document.createElement('div');
        pip.className = 'chord-pip';
        if (i < currentChordIndex) pip.classList.add('complete');
        if (i === currentChordIndex) pip.classList.add('current');
        pip.textContent = chord.root + chord.quality;
        progressBar.appendChild(pip);
      });
    }

    function renderChord() {
      const chord = chords[currentChordIndex];
      chordRoot.textContent = chord.root;
      chordQuality.textContent = chord.quality;
      
      notePills.innerHTML = '';
      chord.notes.forEach(note => {
        const pill = document.createElement('span');
        pill.className = 'note-pill';
        pill.id = 'pill-' + note;
        if (playedNotes.has(note)) pill.classList.add('played');
        pill.textContent = note;
        notePills.appendChild(pill);
      });
      
      playedCount.textContent = playedNotes.size;
    }

    function renderFretboard() {
      const chord = chords[currentChordIndex];
      const showAll = showAllPositions.checked;
      
      // Get positions for each note
      const notePositions = {};
      chord.notes.forEach((note, i) => {
        const positions = getNotePositions(note);
        if (showAll) {
          notePositions[note] = { positions, type: ['root', 'third', 'fifth'][i] };
        } else {
          // Best position: prefer lower frets
          const best = positions.sort((a, b) => a.fret - b.fret)[0];
          notePositions[note] = { positions: best ? [best] : [], type: ['root', 'third', 'fifth'][i] };
        }
      });

      let html = '';
      
      // Strings (G, D, A, E from top to bottom visually)
      for (let s = 3; s >= 0; s--) {
        html += `<div class="fret-row">
          <span class="string-label">${STRING_NAMES[s]}</span>
          <div class="frets">
            <div class="string-line"></div>`;
        
        for (let f = 0; f <= FRET_COUNT; f++) {
          html += `<div class="fret">`;
          
          // Check if any note is at this position
          for (const [note, data] of Object.entries(notePositions)) {
            const pos = data.positions.find(p => p.string === s && p.fret === f);
            if (pos) {
              const played = playedNotes.has(note);
              html += `<div class="note-marker ${data.type} ${played ? 'played' : ''}">${note}</div>`;
            }
          }
          
          html += `</div>`;
        }
        
        html += `</div></div>`;
      }
      
      // Fret numbers
      html += `<div class="fret-numbers">`;
      for (let f = 0; f <= FRET_COUNT; f++) {
        html += `<span class="fret-num">${f}</span>`;
      }
      html += `</div>`;
      
      // Fret markers
      html += `<div class="fret-markers">`;
      for (let f = 0; f <= FRET_COUNT; f++) {
        const hasDot = [3, 5, 7, 9, 12, 15].includes(f);
        html += `<div class="fret-marker-dot ${f === 12 ? 'twelve' : ''}">${hasDot ? '<span></span>' : ''}</div>`;
      }
      html += `</div>`;
      
      fretboard.innerHTML = html;
    }

    function handleMIDI(event) {
      const [status, note, velocity] = event.data;
      if ((status & 0xf0) === 0x90 && velocity > 0) {
        noteOn(getNoteName(note));
      }
    }

    function handleKeyboard(e) {
      const keyMap = {
        'a': 'C', 'w': 'C#', 's': 'D', 'e': 'D#', 'd': 'E',
        'f': 'F', 't': 'F#', 'g': 'G', 'y': 'G#', 'h': 'A',
        'u': 'A#', 'j': 'B'
      };
      const note = keyMap[e.key.toLowerCase()];
      if (note && selectedKey) noteOn(note);
    }

    function noteOn(noteName) {
      const chord = chords[currentChordIndex];
      if (!chord) return;
      
      if (chord.notes.includes(noteName)) {
        playedNotes.add(noteName);
        
        // Update UI
        const pill = document.getElementById('pill-' + noteName);
        if (pill) pill.classList.add('played');
        playedCount.textContent = playedNotes.size;
        renderFretboard();
        
        // Check completion
        if (chord.notes.every(n => playedNotes.has(n))) {
          setTimeout(() => {
            if (currentChordIndex < chords.length - 1) {
              currentChordIndex++;
              playedNotes.clear();
              renderProgress();
              renderChord();
              renderFretboard();
            } else {
              showComplete();
            }
          }, 400);
        }
      }
    }

    function showComplete() {
      gameScreen.classList.remove('active');
      completeScreen.classList.add('active');
      completedKey.textContent = selectedKey;
    }

    function resetGame() {
      currentChordIndex = 0;
      playedNotes.clear();
      completeScreen.classList.remove('active');
      gameScreen.classList.add('active');
      renderProgress();
      renderChord();
      renderFretboard();
    }

    function changeKey() {
      selectedKey = null;
      gameScreen.classList.remove('active');
      completeScreen.classList.remove('active');
      keySelect.style.display = 'block';
    }

    init();
  </script>
</body>
</html>
