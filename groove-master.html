<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Groove Master - Bass Trainer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      color: #1e293b;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      height: 100vh;
    }
    
    /* Light Colored Panel */
    .side-panel {
      width: 320px;
      background: rgba(255,255,255,0.95);
      border-right: 2px solid rgba(37,99,235,0.2);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .back-link {
      color: #64748b;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .back-link:hover { color: #2563eb; }
    
    .panel-title {
      font-size: 1.25rem;
      color: #1e293b;
      font-weight: 700;
    }
    
    .setting-group {
      background: rgba(37,99,235,0.05);
      border: 1px solid rgba(37,99,235,0.15);
      border-radius: 12px;
      padding: 16px;
    }
    
    .setting-group label {
      display: block;
      font-size: 0.75rem;
      color: #475569;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .setting-group select,
    .setting-group input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      background: #ffffff;
      border: 1px solid rgba(37,99,235,0.2);
      border-radius: 8px;
      color: #1e293b;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }
    
    .setting-row {
      display: flex;
      gap: 12px;
    }
    .setting-row .setting-group { flex: 1; }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2563eb;
    }
    .checkbox-group label {
      margin: 0;
      color: #1e293b;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .btn {
      padding: 12px 18px;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      border: 2px solid;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-start {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    .btn-start:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }
    
    .btn-pause {
      background: #0891b2;
      color: white;
      border-color: #0891b2;
    }
    .btn-pause:hover {
      background: #0e7490;
      border-color: #0e7490;
    }
    
    .btn-stop {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    .btn-stop:hover {
      background: #b91c1c;
      border-color: #b91c1c;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
    }
    
    .live-stats {
      background: rgba(37,99,235,0.08);
      border-radius: 10px;
      padding: 16px;
      font-size: 0.85rem;
    }
    
    .live-stats div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .live-stats div:last-child { margin-bottom: 0; }
    
    .stat-label { color: #64748b; font-weight: 500; }
    .stat-value { color: #2563eb; font-weight: 600; }
    .stat-value.good { color: #059669; }
    .stat-value.bad { color: #dc2626; }
    
    /* Black Gameplay Area with Mathematical Animation */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #000;
      overflow: hidden;
    }
    
    /* Mathematical Animation Canvas (Background) */
    .math-animation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      opacity: 0.15;
    }
    
    /* Time Signature Display */
    .time-sig-display {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(0,0,0,0.8);
      border: 2px solid rgba(37,99,235,0.6);
      border-radius: 12px;
      padding: 12px 20px;
    }
    
    .time-sig-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #60a5fa;
      line-height: 1;
    }
    
    .time-sig-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Game Canvas (Notes Track) */
    .game-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
    }
    
    /* Vertical Bar (Strike Zone) */
    .strike-bar {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #2563eb 0%, #60a5fa 50%, #2563eb 100%);
      box-shadow: 0 0 20px rgba(37,99,235,0.8), 0 0 40px rgba(37,99,235,0.4);
      z-index: 5;
      animation: pulseBar 2s ease-in-out infinite;
    }
    
    @keyframes pulseBar {
      0%, 100% { opacity: 0.8; box-shadow: 0 0 20px rgba(37,99,235,0.8), 0 0 40px rgba(37,99,235,0.4); }
      50% { opacity: 1; box-shadow: 0 0 30px rgba(37,99,235,1), 0 0 60px rgba(37,99,235,0.6); }
    }
    
    /* Notes will be drawn on canvas over the animation background */
  </style>
</head>
<body>
  <div class="app">
    <!-- Light Colored Settings Panel -->
    <div class="side-panel">
      <div class="panel-header">
        <div class="panel-title">üé∏ Groove Master</div>
        <a href="../" class="back-link">‚Üê Games</a>
      </div>

      <div class="setting-group">
        <label>Time Signature</label>
        <select id="time-sig">
          <option value="4/4">4/4 (Standard)</option>
          <option value="3/4">3/4 (Waltz)</option>
          <option value="2/4">2/4 (March)</option>
          <option value="5/4">5/4 (Take Five)</option>
          <option value="7/8">7/8 (Odd)</option>
          <option value="6/8">6/8 (Compound)</option>
          <option value="9/8">9/8 (Compound)</option>
          <option value="12/8">12/8 (Compound)</option>
          <option value="5/8">5/8 (Dave Brubeck)</option>
          <option value="7/4">7/4 (Pink Floyd)</option>
        </select>
      </div>

      <div class="setting-row">
        <div class="setting-group">
          <label>Start BPM</label>
          <input type="number" id="start-bpm" value="72" min="40" max="200">
        </div>
        <div class="setting-group">
          <label>Acceleration</label>
          <input type="number" id="acceleration" value="0" min="0" max="5" step="0.1">
        </div>
      </div>

      <div class="setting-group">
        <label>Root Note</label>
        <select id="root-note">
          <option value="0">C</option>
          <option value="1">C#</option>
          <option value="2">D</option>
          <option value="3">D#</option>
          <option value="4">E</option>
          <option value="5">F</option>
          <option value="6">F#</option>
          <option value="7">G</option>
          <option value="8">G#</option>
          <option value="9">A</option>
          <option value="10">A#</option>
          <option value="11">B</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Note Mode</label>
        <select id="note-mode">
          <option value="scale">Scale Notes</option>
          <option value="interval">Intervals</option>
          <option value="triad">Triads</option>
          <option value="random">Random Fretboard</option>
        </select>
      </div>

      <div class="setting-group" id="scale-settings">
        <label>Scale Type</label>
        <select id="scale-type">
          <option value="major">Major (Ionian)</option>
          <option value="minor">Natural Minor (Aeolian)</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="minor-pentatonic">Minor Pentatonic</option>
          <option value="major-pentatonic">Major Pentatonic</option>
          <option value="blues">Blues Scale</option>
          <option value="chromatic">Chromatic</option>
        </select>
      </div>

      <div class="setting-group" id="interval-settings" style="display:none;">
        <label>Interval</label>
        <select id="interval-select">
          <option value="1">Perfect Unison</option>
          <option value="2">Minor 2nd</option>
          <option value="3">Major 2nd</option>
          <option value="4">Minor 3rd</option>
          <option value="5">Major 3rd</option>
          <option value="6">Perfect 4th</option>
          <option value="7">Tritone</option>
          <option value="8">Perfect 5th</option>
          <option value="9">Minor 6th</option>
          <option value="10">Major 6th</option>
          <option value="11">Minor 7th</option>
          <option value="12">Major 7th</option>
          <option value="13">Octave</option>
        </select>
      </div>

      <div class="setting-group" id="triad-settings" style="display:none;">
        <label>Triad Type</label>
        <select id="triad-select">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="diminished">Diminished</option>
          <option value="augmented">Augmented</option>
          <option value="sus2">Sus2</option>
          <option value="sus4">Sus4</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Rhythm Pattern</label>
        <select id="rhythm-pattern">
          <option value="quarter">Quarter Notes</option>
          <option value="eighth">Eighth Notes</option>
          <option value="dotted-eighth">Dotted Eighths</option>
          <option value="sixteenth">Sixteenth Notes</option>
          <option value="triplets">Triplets</option>
          <option value="syncopated">Syncopated</option>
          <option value="mixed">Mixed Rhythms</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Sensitivity</label>
        <input type="range" id="sensitivity" min="0.1" max="2" step="0.1" value="0.8">
        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:#64748b;margin-top:4px;">
          <span>Low</span><span>High</span>
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="metronome-enabled" checked>
        <label for="metronome-enabled">Metronome Click</label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="auto-advance" checked>
        <label for="auto-advance">Auto Advance Scale</label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="visual-feedback">
        <label for="visual-feedback">Visual Hit Feedback</label>
      </div>

      <div class="live-stats">
        <div><span class="stat-label">BPM:</span> <span class="stat-value" id="current-bpm">72</span></div>
        <div><span class="stat-label">Beat:</span> <span class="stat-value" id="current-beat">1</span></div>
        <div><span class="stat-label">Hits:</span> <span class="stat-value good" id="hit-count">0</span></div>
        <div><span class="stat-label">Misses:</span> <span class="stat-value bad" id="miss-count">0</span></div>
        <div><span class="stat-label">Accuracy:</span> <span class="stat-value" id="accuracy">100%</span></div>
      </div>

      <div class="controls">
        <button class="btn btn-start" id="start-btn">‚ñ∂ Start Practice</button>
        <button class="btn btn-pause" id="pause-btn" style="display:none;">‚è∏ Pause</button>
        <button class="btn btn-stop" id="stop-btn" style="display:none;">‚èπ Stop</button>
      </div>
    </div>

    <!-- Black Gameplay Area -->
    <div class="main-area">
      <!-- Mathematical Animation Background -->
      <canvas class="math-animation" id="math-canvas"></canvas>
      
      <!-- Central Vertical Bar -->
      <div class="strike-bar"></div>
      
      <!-- Time Signature Display -->
      <div class="time-sig-display">
        <div class="time-sig-number" id="time-sig-num">4</div>
        <div class="time-sig-label" id="time-sig-den">4</div>
      </div>
      
      <!-- Game Canvas for Notes -->
      <canvas class="game-canvas" id="track"></canvas>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    
    // Perlin Noise for Mathematical Animation
    class PerlinNoise {
      constructor(seed = Math.random() * 10000) {
        this.perm = [];
        const p = [];
        for (let i = 0; i < 256; i++) p[i] = i;
        let n = seed;
        for (let i = 255; i > 0; i--) {
          n = (n * 16807) % 2147483647;
          const j = n % (i + 1);
          [p[i], p[j]] = [p[j], p[i]];
        }
        for (let i = 0; i < 512; i++) this.perm[i] = p[i & 255];
      }
      
      fade(t) { return t * t * t * (t * (t * 6 - 15) + 10); }
      lerp(a, b, t) { return a + t * (b - a); }
      
      grad(hash, x, y, z = 0) {
        const h = hash & 15;
        const u = h < 8 ? x : y;
        const v = h < 4 ? y : h === 12 || h === 14 ? x : z;
        return ((h & 1) ? -u : u) + ((h & 2) ? -v : v);
      }
      
      noise(x, y, z = 0) {
        const X = Math.floor(x) & 255, Y = Math.floor(y) & 255, Z = Math.floor(z) & 255;
        x -= Math.floor(x); y -= Math.floor(y); z -= Math.floor(z);
        const u = this.fade(x), v = this.fade(y), w = this.fade(z);
        const A = this.perm[X] + Y, AA = this.perm[A] + Z, AB = this.perm[A + 1] + Z;
        const B = this.perm[X + 1] + Y, BA = this.perm[B] + Z, BB = this.perm[B + 1] + Z;
        return this.lerp(this.lerp(this.lerp(this.grad(this.perm[AA], x, y, z), this.grad(this.perm[BA], x - 1, y, z), u),
          this.lerp(this.grad(this.perm[AB], x, y - 1, z), this.grad(this.perm[BB], x - 1, y - 1, z), u), v),
          this.lerp(this.lerp(this.grad(this.perm[AA + 1], x, y, z - 1), this.grad(this.perm[BA + 1], x - 1, y, z - 1), u),
          this.lerp(this.grad(this.perm[AB + 1], x, y - 1, z - 1), this.grad(this.perm[BB + 1], x - 1, y - 1, z - 1), u), v), w) * 0.5 + 0.5;
      }
    }
    
    // Mathematical Animation Setup
    const mathCanvas = $('math-canvas');
    const mathCtx = mathCanvas.getContext('2d');
    const noise = new PerlinNoise();
    let animTime = 0;
    
    function resizeMathCanvas() {
      mathCanvas.width = mathCanvas.offsetWidth * window.devicePixelRatio;
      mathCanvas.height = mathCanvas.offsetHeight * window.devicePixelRatio;
      mathCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    
    function drawMathAnimation() {
      const w = mathCanvas.offsetWidth;
      const h = mathCanvas.offsetHeight;
      animTime += 0.003;
      
      mathCtx.clearRect(0, 0, w, h);
      mathCtx.strokeStyle = "rgba(37, 99, 235, 0.3)";
      mathCtx.lineWidth = 0.5;
      
      // Flowing creature pattern inspired by yuruyurau
      for (let i = 0; i < 8000; i++) {
        const y = i / 400;
        const distance = Math.pow(Math.abs((4 + Math.sin(y * 2 - animTime) * 3) * Math.cos(i / 29)), 2) / 99 + 
                        Math.sin(animTime * 2) / 6 + 0.5;
        if (distance < 1) {
          const x = (w / 2) + (4 + Math.sin(y * 2 - animTime) * 3) * Math.cos(i / 29) * 2;
          const yPos = y * 8 - h / 4;
          
          mathCtx.fillStyle = `rgba(37, 99, 235, ${0.1 + distance * 0.15})`;
          mathCtx.beginPath();
          mathCtx.arc(x, yPos + h / 2, 1, 0, Math.PI * 2);
          mathCtx.fill();
        }
      }
      
      requestAnimationFrame(drawMathAnimation);
    }
    
    // Game Variables
    let state = {
      running: false,
      paused: false,
      startTime: 0,
      pausedTime: 0,
      baseBpm: 72,
      bpm: 72,
      acceleration: 0,
      rootNote: 0,
      noteMode: 'scale',
      interval: 1,
      triadType: 'major',
      scaleType: 'major',
      rhythmPattern: 'quarter',
      timeSig: '4/4',
      beatsPerMeasure: 4,
      beatUnit: 4,
      scaleNotes: [],
      currentScaleIndex: 0,
      rhythmIndex: 0,
      notes: [],
      hits: 0,
      misses: 0,
      lastBeatTime: 0,
      currentBeat: 1
    };
    
    let audioContext, metronomeOscillator, metronomeGain;
    let lastTime = 0;
    
    // Audio Analysis
    let analyser, dataArray, bufferLength;
    let sensitivity = 0.8;
    
    // Game Canvas Setup
    const canvas = $('track');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
      canvas.width = canvas.offsetWidth * window.devicePixelRatio;
      canvas.height = canvas.offsetHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    
    // Scale Definitions
    const scales = {
      major: [0, 2, 4, 5, 7, 9, 11],
      minor: [0, 2, 3, 5, 7, 8, 10],
      dorian: [0, 2, 3, 5, 7, 9, 10],
      phrygian: [0, 1, 3, 5, 7, 8, 10],
      lydian: [0, 2, 4, 6, 7, 9, 11],
      mixolydian: [0, 2, 4, 5, 7, 9, 10],
      locrian: [0, 1, 3, 5, 6, 8, 10],
      'minor-pentatonic': [0, 3, 5, 7, 10],
      'major-pentatonic': [0, 2, 4, 7, 9],
      blues: [0, 3, 5, 6, 7, 10],
      chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    };
    
    const triads = {
      major: [0, 4, 7],
      minor: [0, 3, 7],
      diminished: [0, 3, 6],
      augmented: [0, 4, 8],
      sus2: [0, 2, 7],
      sus4: [0, 5, 7]
    };
    
    const rhythmPatterns = {
      quarter: [1],
      eighth: [0.5, 0.5],
      'dotted-eighth': [0.75, 0.25],
      sixteenth: [0.25, 0.25, 0.25, 0.25],
      triplets: [1/3, 1/3, 1/3],
      syncopated: [0.5, 0.25, 0.25],
      mixed: [1, 0.5, 0.5, 0.25, 0.25, 0.5]
    };
    
    // Note names for display
    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    function parseTimeSig(timeSig) {
      const [beats, unit] = timeSig.split('/').map(Number);
      return { beatsPerMeasure: beats, beatUnit: unit };
    }
    
    function updateTimeSigDisplay() {
      const { beatsPerMeasure, beatUnit } = parseTimeSig(state.timeSig);
      $('time-sig-num').textContent = beatsPerMeasure;
      $('time-sig-den').textContent = beatUnit;
    }
    
    function getNoteSequence() {
      const rootNote = state.rootNote;
      
      switch (state.noteMode) {
        case 'scale':
          const scaleIntervals = scales[state.scaleType];
          return scaleIntervals.map(interval => (rootNote + interval) % 12);
          
        case 'interval':
          const intervalSemitones = parseInt(state.interval) - 1;
          return [rootNote, (rootNote + intervalSemitones) % 12];
          
        case 'triad':
          const triadIntervals = triads[state.triadType];
          return triadIntervals.map(interval => (rootNote + interval) % 12);
          
        case 'random':
          return [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
          
        default:
          return [rootNote];
      }
    }
    
    async function initAudio() {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        if (audioContext.state === 'suspended') {
          await audioContext.resume();
        }
        
        // Get microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(stream);
        
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        source.connect(analyser);
        
        // Metronome setup
        metronomeGain = audioContext.createGain();
        metronomeGain.connect(audioContext.destination);
        metronomeGain.gain.value = 0.3;
        
      } catch (err) {
        console.error('Audio initialization failed:', err);
        alert('Microphone access required for gameplay');
      }
    }
    
    function playMetronomeClick() {
      if (!$('metronome-enabled').checked || !audioContext) return;
      
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      osc.connect(gain);
      gain.connect(metronomeGain);
      
      osc.frequency.value = state.currentBeat === 1 ? 1000 : 800;
      osc.type = 'square';
      
      gain.gain.setValueAtTime(0.5, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.1);
    }
    
    function detectNote() {
      if (!analyser) return null;
      
      analyser.getByteFrequencyData(dataArray);
      
      let maxVolume = 0;
      let dominantFreqIndex = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        if (dataArray[i] > maxVolume) {
          maxVolume = dataArray[i];
          dominantFreqIndex = i;
        }
      }
      
      if (maxVolume < 50 * sensitivity) return null;
      
      const nyquist = audioContext.sampleRate / 2;
      const frequency = (dominantFreqIndex * nyquist) / bufferLength;
      
      if (frequency < 50 || frequency > 350) return null;
      
      const noteNumber = Math.round(12 * Math.log2(frequency / 82.41)) % 12;
      return noteNumber < 0 ? noteNumber + 12 : noteNumber;
    }
    
    function updateStats() {
      const total = state.hits + state.misses;
      const accuracy = total > 0 ? Math.round((state.hits / total) * 100) : 100;
      
      $('current-bpm').textContent = Math.round(state.bpm);
      $('current-beat').textContent = state.currentBeat;
      $('hit-count').textContent = state.hits;
      $('miss-count').textContent = state.misses;
      $('accuracy').textContent = accuracy + '%';
    }
    
    function addNote() {
      const pattern = rhythmPatterns[state.rhythmPattern];
      const rhythmBeat = pattern[state.rhythmIndex % pattern.length];
      
      let targetNote;
      if (state.noteMode === 'random') {
        targetNote = Math.floor(Math.random() * 12);
      } else {
        targetNote = state.scaleNotes[state.currentScaleIndex % state.scaleNotes.length];
      }
      
      const note = {
        x: canvas.offsetWidth - 50,
        y: canvas.offsetHeight / 2,
        targetNote: targetNote,
        hit: false,
        missed: false,
        createdTime: performance.now()
      };
      
      state.notes.push(note);
      state.rhythmIndex++;
      
      if ($('auto-advance').checked && state.noteMode !== 'random') {
        state.currentScaleIndex++;
      }
    }
    
    function updateNotes() {
      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      const speed = (state.bpm / 60) * 150;
      const strikeZone = w / 2;
      const strikeWidth = 40;
      
      for (let i = state.notes.length - 1; i >= 0; i--) {
        const note = state.notes[i];
        note.x -= speed * 0.016;
        
        const detectedNote = detectNote();
        
        if (!note.hit && !note.missed && 
            note.x <= strikeZone + strikeWidth && note.x >= strikeZone - strikeWidth) {
          
          if (detectedNote === note.targetNote) {
            note.hit = true;
            state.hits++;
            if ($('visual-feedback').checked) {
              note.color = '#10b981';
            }
          }
        }
        
        if (!note.hit && !note.missed && note.x < strikeZone - strikeWidth) {
          note.missed = true;
          state.misses++;
          if ($('visual-feedback').checked) {
            note.color = '#ef4444';
          }
        }
        
        if (note.x < -100) {
          state.notes.splice(i, 1);
        }
      }
      
      updateStats();
    }
    
    function draw() {
      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      
      ctx.clearRect(0, 0, w, h);
      
      // Draw notes
      state.notes.forEach(note => {
        ctx.fillStyle = note.hit ? '#10b981' : note.missed ? '#ef4444' : '#2563eb';
        ctx.shadowColor = note.hit ? '#10b981' : note.missed ? '#ef4444' : '#2563eb';
        ctx.shadowBlur = 10;
        
        // Note body
        ctx.fillRect(note.x - 25, note.y - 15, 50, 30);
        
        // Note name
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px Inter';
        ctx.textAlign = 'center';
        ctx.shadowBlur = 0;
        ctx.fillText(noteNames[note.targetNote], note.x, note.y + 5);
      });
    }
    
    function loop(currentTime) {
      if (!state.running || state.paused) return;
      
      const elapsed = currentTime - state.startTime - state.pausedTime;
      const currentBpm = state.baseBpm + (state.acceleration * elapsed / 60000);
      state.bpm = currentBpm;
      
      const beatInterval = 60000 / (currentBpm * (state.beatUnit / 4));
      
      if (currentTime - state.lastBeatTime >= beatInterval) {
        playMetronomeClick();
        addNote();
        
        state.lastBeatTime = currentTime;
        state.currentBeat = (state.currentBeat % state.beatsPerMeasure) + 1;
      }
      
      updateNotes();
      draw();
      
      requestAnimationFrame(loop);
    }
    
    async function startGame() {
      try {
        const ok = await new Promise(resolve => {
          const btn = document.createElement('button');
          btn.textContent = 'Enable Audio & Microphone';
          btn.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #2563eb; color: white; padding: 16px 24px; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer; z-index: 1000;
          `;
          document.body.appendChild(btn);
          
          btn.onclick = () => {
            document.body.removeChild(btn);
            resolve(true);
          };
        });
        
        if (!ok) return;
      } catch (err) {
        console.error('Start failed:', err);
        return;
      }
      
      await initAudio();
      
      const { beatsPerMeasure, beatUnit } = parseTimeSig($('time-sig').value);
      
      state = {
        ...state,
        running: true,
        paused: false,
        startTime: performance.now(),
        pausedTime: 0,
        baseBpm: parseInt($('start-bpm').value) || 72,
        bpm: parseInt($('start-bpm').value) || 72,
        acceleration: parseFloat($('acceleration').value) || 0,
        rootNote: parseInt($('root-note').value),
        noteMode: $('note-mode').value,
        interval: parseInt($('interval-select').value),
        triadType: $('triad-select').value,
        scaleType: $('scale-type').value,
        rhythmPattern: $('rhythm-pattern').value,
        timeSig: $('time-sig').value,
        beatsPerMeasure,
        beatUnit,
        scaleNotes: [],
        currentScaleIndex: 0,
        rhythmIndex: 0,
        notes: [],
        hits: 0,
        misses: 0,
        lastBeatTime: 0,
        currentBeat: 1
      };
      
      state.scaleNotes = getNoteSequence();
      state.lastBeatTime = performance.now();
      lastTime = 0;
      
      updateTimeSigDisplay();
      updateStats();
      
      $('start-btn').style.display = 'none';
      $('pause-btn').style.display = 'block';
      $('stop-btn').style.display = 'block';
      
      document.querySelectorAll('.side-panel select, .side-panel input[type=number]').forEach(el => el.disabled = true);
      
      requestAnimationFrame(loop);
    }
    
    function pauseGame() {
      if (!state.running) return;
      
      if (state.paused) {
        state.pausedTime += performance.now() - state.pauseStartTime;
        state.paused = false;
        $('pause-btn').textContent = '‚è∏ Pause';
        requestAnimationFrame(loop);
      } else {
        state.paused = true;
        state.pauseStartTime = performance.now();
        $('pause-btn').textContent = '‚ñ∂ Resume';
      }
    }
    
    function stopGame() {
      state.running = false;
      state.paused = false;
      state.notes = [];
      
      $('start-btn').style.display = 'block';
      $('pause-btn').style.display = 'none';
      $('stop-btn').style.display = 'none';
      $('pause-btn').textContent = '‚è∏ Pause';
      
      document.querySelectorAll('.side-panel select, .side-panel input[type=number]').forEach(el => el.disabled = false);
      
      ctx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
    }
    
    // Event Listeners
    $('start-btn').addEventListener('click', startGame);
    $('pause-btn').addEventListener('click', pauseGame);
    $('stop-btn').addEventListener('click', stopGame);
    
    $('note-mode').addEventListener('change', (e) => {
      const mode = e.target.value;
      $('scale-settings').style.display = mode === 'scale' ? 'block' : 'none';
      $('interval-settings').style.display = mode === 'interval' ? 'block' : 'none';
      $('triad-settings').style.display = mode === 'triad' ? 'block' : 'none';
    });
    
    $('time-sig').addEventListener('change', updateTimeSigDisplay);
    $('sensitivity').addEventListener('input', (e) => {
      sensitivity = parseFloat(e.target.value);
    });
    
    window.addEventListener('resize', () => {
      resizeCanvas();
      resizeMathCanvas();
    });
    
    // Initialize
    resizeCanvas();
    resizeMathCanvas();
    updateTimeSigDisplay();
    drawMathAnimation(); // Start mathematical animation
  </script>
</body>
</html>