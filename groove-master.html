<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>GROOVE MASTER</title>
  <meta name="description" content="Bass practice with falling notes and mathematical animations">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Syne Mono', monospace;
      background: #000;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      height: 100vh;
    }
    
    /* Light Settings Panel */
    .settings-panel {
      width: 320px;
      background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
      color: #212529;
      padding: 20px;
      overflow-y: auto;
      border-right: 3px solid #0096ff;
      box-shadow: 3px 0 10px rgba(0,150,255,0.3);
    }
    
    .panel-header {
      text-align: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 15px;
    }
    
    .back-link {
      color: #6c757d;
      text-decoration: none;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 10px;
    }
    .back-link:hover { color: #0096ff; }
    
    .panel-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #0096ff;
      text-shadow: 0 2px 4px rgba(0,150,255,0.3);
    }
    
    .setting-group {
      background: #fff;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .setting-group label {
      display: block;
      font-size: 0.8rem;
      color: #495057;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
    }
    
    .setting-group select,
    .setting-group input[type="number"] {
      width: 100%;
      padding: 10px;
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      color: #212529;
      font-family: inherit;
      font-size: 0.9rem;
    }
    
    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: #0096ff;
      box-shadow: 0 0 0 3px rgba(0,150,255,0.2);
    }
    
    .setting-row {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
    }
    .setting-row .setting-group { flex: 1; margin-bottom: 0; }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #0096ff;
    }
    .checkbox-group label {
      margin: 0;
      color: #495057;
      font-size: 0.9rem;
      text-transform: none;
      letter-spacing: 0;
      font-weight: normal;
    }
    
    .sensitivity-row {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #e3f2fd;
      border: 2px solid #0096ff;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 15px;
    }
    
    .sensitivity-row label {
      color: #0096ff;
      font-weight: bold;
      margin: 0;
    }
    
    .sensitivity-row input[type="range"] {
      flex: 1;
      accent-color: #0096ff;
    }
    
    .sensitivity-row #sensitivityValue {
      color: #0096ff;
      font-weight: bold;
      min-width: 30px;
    }
    
    .level-meter {
      width: 60px;
      height: 10px;
      background: rgba(0,0,0,0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .level-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00ff66, #ffcc00, #ff4444);
      transition: width 0.05s;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 15px 20px;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-start {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(40,167,69,0.4); }
    
    .btn-pause {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: #212529;
    }
    .btn-pause:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,193,7,0.4); }
    
    .btn-stop {
      background: linear-gradient(135deg, #dc3545, #e83e8c);
      color: white;
    }
    .btn-stop:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(220,53,69,0.4); }
    
    .stats {
      background: #f8f9fa;
      border: 2px solid #0096ff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .stats h3 {
      color: #0096ff;
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.8rem;
    }
    
    .stat-value {
      font-weight: bold;
      color: #212529;
    }
    .stat-value.good { color: #28a745; }
    .stat-value.bad { color: #dc3545; }
    
    /* Main Game Area - Black with Mathematical Animation */
    .game-area {
      flex: 1;
      position: relative;
      background: #000;
      overflow: hidden;
    }
    
    /* Mathematical Animation Canvas */
    .math-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.3;
      z-index: 1;
    }
    
    /* Game Canvas for Notes */
    .game-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    
    /* Play Bar - Vertical line where notes trigger */
    .play-bar {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, #0096ff 0%, #00d4ff 50%, #0096ff 100%);
      transform: translateX(-50%);
      z-index: 3;
      box-shadow: 0 0 20px rgba(0,150,255,0.8), 0 0 40px rgba(0,150,255,0.4);
    }
    
    .play-bar::before {
      content: '';
      position: absolute;
      top: 45%;
      left: -15px;
      width: 34px;
      height: 10px;
      background: rgba(0,150,255,0.3);
      border-radius: 5px;
      border: 2px solid #0096ff;
    }
    
    /* BPM Display */
    .bpm-display {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,150,255,0.2);
      border: 2px solid #0096ff;
      border-radius: 12px;
      padding: 15px 20px;
      z-index: 4;
      text-align: center;
    }
    
    .bpm-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #0096ff;
      line-height: 1;
      text-shadow: 0 0 15px rgba(0,150,255,0.8);
    }
    
    .bpm-label {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
    }
    
    /* Beat Counter */
    .beat-counter {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 4;
    }
    
    .beat-dot {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(0,150,255,0.2);
      border: 3px solid rgba(0,150,255,0.4);
      transition: all 0.1s;
    }
    
    .beat-dot.active {
      background: #0096ff;
      box-shadow: 0 0 20px rgba(0,150,255,0.8);
    }
    
    .beat-dot.downbeat {
      border-color: #00ff66;
    }
    .beat-dot.downbeat.active {
      background: #00ff66;
      box-shadow: 0 0 20px rgba(0,255,102,0.8);
    }
    
    /* Note Hit Feedback */
    .note-feedback {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      border: 2px solid #0096ff;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 4;
      transition: all 0.3s;
    }
    
    .note-feedback.hit {
      color: #00ff66;
      border-color: #00ff66;
      box-shadow: 0 0 20px rgba(0,255,102,0.5);
    }
    
    .note-feedback.miss {
      color: #ff4444;
      border-color: #ff4444;
      box-shadow: 0 0 20px rgba(255,68,68,0.5);
    }
  </style>
  <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
  <div class="app">
    <!-- Light Settings Panel -->
    <div class="settings-panel">
      <div class="panel-header">
        <a href="index.html" class="back-link">‚Üê Back to Bass Lab</a>
        <div class="panel-title">üé∏ GROOVE MASTER</div>
      </div>
      
      <div class="setting-group">
        <label>Root Note</label>
        <select id="root-note">
          <option value="0">C</option>
          <option value="1">C# / Db</option>
          <option value="2">D</option>
          <option value="3">D# / Eb</option>
          <option value="4" selected>E</option>
          <option value="5">F</option>
          <option value="6">F# / Gb</option>
          <option value="7">G</option>
          <option value="8">G# / Ab</option>
          <option value="9">A</option>
          <option value="10">A# / Bb</option>
          <option value="11">B</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>Scale Type</label>
        <select id="scale-type">
          <option value="pentatonic" selected>Pentatonic</option>
          <option value="blues">Blues</option>
          <option value="major">Major</option>
          <option value="natural-minor">Natural Minor</option>
          <option value="dorian">Dorian</option>
          <option value="mixolydian">Mixolydian</option>
        </select>
      </div>
      
      <div class="setting-row">
        <div class="setting-group">
          <label>BPM</label>
          <input type="number" id="bpm" value="80" min="40" max="200">
        </div>
        <div class="setting-group">
          <label>Time Sig</label>
          <select id="time-sig">
            <option value="4">4/4</option>
            <option value="3">3/4</option>
            <option value="6">6/8</option>
          </select>
        </div>
      </div>
      
      <div class="setting-group">
        <div class="checkbox-group">
          <input type="checkbox" id="metronome" checked>
          <label for="metronome">üîä Metronome</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="accent-downbeat" checked>
          <label for="accent-downbeat">Accent Downbeat</label>
        </div>
      </div>
      
      <div class="sensitivity-row">
        <label for="sensitivity">üé§ Sensitivity:</label>
        <input type="range" id="sensitivity" min="1" max="100" value="50">
        <span id="sensitivityValue">50</span>
        <div class="level-meter"><div class="level-fill" id="levelFill"></div></div>
      </div>
      
      <div class="stats">
        <h3>Session Stats</h3>
        <div class="stat-row">
          <span class="stat-label">BPM</span>
          <span class="stat-value" id="current-bpm">80</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Beat</span>
          <span class="stat-value" id="current-beat">1</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Hits</span>
          <span class="stat-value good" id="hits">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Misses</span>
          <span class="stat-value bad" id="misses">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Accuracy</span>
          <span class="stat-value" id="accuracy">--%</span>
        </div>
      </div>
      
      <div class="controls">
        <button class="btn btn-start" id="start-btn">‚ñ∂ Start</button>
        <button class="btn btn-pause" id="pause-btn" style="display:none;">‚è∏ Pause</button>
        <button class="btn btn-stop" id="stop-btn" style="display:none;">‚èπ Stop</button>
      </div>
    </div>
    
    <!-- Game Area with Mathematical Animation -->
    <div class="game-area">
      <!-- Mathematical Animation Background -->
      <canvas class="math-canvas" id="math-canvas"></canvas>
      
      <!-- Game Canvas for Falling Notes -->
      <canvas class="game-canvas" id="game-canvas"></canvas>
      
      <!-- Play Bar -->
      <div class="play-bar" id="play-bar"></div>
      
      <!-- BPM Display -->
      <div class="bpm-display">
        <div class="bpm-number" id="bpm-number">80</div>
        <div class="bpm-label">BPM</div>
      </div>
      
      <!-- Beat Counter -->
      <div class="beat-counter" id="beat-counter">
        <div class="beat-dot downbeat"></div>
        <div class="beat-dot"></div>
        <div class="beat-dot"></div>
        <div class="beat-dot"></div>
      </div>
      
      <!-- Note Feedback -->
      <div class="note-feedback" id="note-feedback">üé∏ --</div>
    </div>
  </div>

  <script>
    // Constants
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const SCALES = {
      'pentatonic': [0, 2, 4, 7, 9],
      'blues': [0, 3, 5, 6, 7, 10],
      'major': [0, 2, 4, 5, 7, 9, 11],
      'natural-minor': [0, 2, 3, 5, 7, 8, 10],
      'dorian': [0, 2, 3, 5, 7, 9, 10],
      'mixolydian': [0, 2, 4, 5, 7, 9, 10]
    };
    
    // DOM elements
    const $ = id => document.getElementById(id);
    
    // Game state
    let state = {
      running: false,
      paused: false,
      bpm: 80,
      timeSignature: 4,
      currentBeat: 0,
      notes: [],
      hits: 0,
      misses: 0,
      startTime: 0,
      lastBeatTime: 0,
      scale: [],
      audioCtx: null
    };
    
    // Mic state
    let micState = {
      enabled: false,
      analyzer: null,
      rmsThreshold: 0.08
    };
    
    // Canvas contexts
    let mathCtx, gameCtx;
    let mathCanvas, gameCanvas;
    
    // Mathematical animation (from creatures page)
    class PerlinNoise {
      constructor(seed = Math.random() * 10000) {
        this.perm = [];
        const p = [];
        for (let i = 0; i < 256; i++) p[i] = i;
        let n = seed;
        for (let i = 255; i > 0; i--) {
          n = (n * 16807) % 2147483647;
          const j = n % (i + 1);
          [p[i], p[j]] = [p[j], p[i]];
        }
        for (let i = 0; i < 512; i++) this.perm[i] = p[i & 255];
      }
      
      fade(t) { return t * t * t * (t * (t * 6 - 15) + 10); }
      lerp(a, b, t) { return a + t * (b - a); }
      
      grad(hash, x, y, z = 0) {
        const h = hash & 15;
        const u = h < 8 ? x : y;
        const v = h < 4 ? y : h === 12 || h === 14 ? x : z;
        return ((h & 1) ? -u : u) + ((h & 2) ? -v : v);
      }
      
      noise(x, y, z = 0) {
        const X = Math.floor(x) & 255, Y = Math.floor(y) & 255, Z = Math.floor(z) & 255;
        x -= Math.floor(x); y -= Math.floor(y); z -= Math.floor(z);
        const u = this.fade(x), v = this.fade(y), w = this.fade(z);
        const A = this.perm[X] + Y, AA = this.perm[A] + Z, AB = this.perm[A + 1] + Z;
        const B = this.perm[X + 1] + Y, BA = this.perm[B] + Z, BB = this.perm[B + 1] + Z;
        return this.lerp(this.lerp(this.lerp(this.grad(this.perm[AA], x, y, z), this.grad(this.perm[BA], x - 1, y, z), u),
          this.lerp(this.grad(this.perm[AB], x, y - 1, z), this.grad(this.perm[BB], x - 1, y - 1, z), u), v),
          this.lerp(this.lerp(this.grad(this.perm[AA + 1], x, y, z - 1), this.grad(this.perm[BA + 1], x - 1, y, z - 1), u),
          this.lerp(this.grad(this.perm[AB + 1], x, y - 1, z - 1), this.grad(this.perm[BB + 1], x - 1, y - 1, z - 1), u), v), w) * 0.5 + 0.5;
      }
    }
    
    const noise = new PerlinNoise();
    let mathTime = 0;
    
    function initCanvases() {
      mathCanvas = $('math-canvas');
      gameCanvas = $('game-canvas');
      mathCtx = mathCanvas.getContext('2d');
      gameCtx = gameCanvas.getContext('2d');
      
      function resizeCanvases() {
        const rect = mathCanvas.parentElement.getBoundingClientRect();
        [mathCanvas, gameCanvas].forEach(canvas => {
          canvas.width = rect.width;
          canvas.height = rect.height;
        });
      }
      
      resizeCanvases();
      window.addEventListener('resize', resizeCanvases);
    }
    
    function drawMathAnimation() {
      if (!mathCtx) return;
      
      const w = mathCanvas.width;
      const h = mathCanvas.height;
      
      mathCtx.clearRect(0, 0, w, h);
      mathCtx.globalCompositeOperation = 'screen';
      
      // Draw flowing mathematical pattern
      for (let i = 0; i < 5000; i++) {
        const t = mathTime * 0.01;
        const x = (i % 50) * (w / 50);
        const y = Math.floor(i / 50) * (h / 100);
        
        const noiseX = noise.noise(x * 0.01, y * 0.01, t);
        const noiseY = noise.noise(x * 0.01 + 100, y * 0.01, t);
        
        const finalX = x + noiseX * 50;
        const finalY = y + noiseY * 50;
        
        const intensity = noise.noise(finalX * 0.005, finalY * 0.005, t * 0.5);
        
        mathCtx.fillStyle = `rgba(0, 150, 255, ${intensity * 0.1})`;
        mathCtx.fillRect(finalX, finalY, 2, 2);
      }
      
      mathTime++;
    }
    
    // Falling note class
    class FallingNote {
      constructor(noteName, lane) {
        this.noteName = noteName;
        this.lane = lane; // 0-3 for bass strings
        this.x = gameCanvas.width / 2; // Center column
        this.y = -50; // Start above screen
        this.speed = (state.bpm / 60) * 100; // Pixels per second
        this.hit = false;
        this.missed = false;
        this.size = 40;
      }
      
      update(deltaTime) {
        this.y += this.speed * (deltaTime / 1000);
        
        // Check if note passed through play bar
        const playBarY = gameCanvas.height / 2;
        if (!this.hit && !this.missed && Math.abs(this.y - playBarY) < 30) {
          // Note is in trigger zone
          this.checkForHit();
        }
        
        // Remove if off screen
        if (this.y > gameCanvas.height + 100) {
          if (!this.hit && !this.missed) {
            this.missed = true;
            state.misses++;
            updateStats();
            showFeedback('miss', this.noteName);
          }
          return false; // Remove this note
        }
        return true; // Keep this note
      }
      
      checkForHit() {
        // This will be called by mic detection when note is played
      }
      
      draw() {
        if (!gameCtx) return;
        
        gameCtx.save();
        
        // Note glow
        gameCtx.shadowBlur = 15;
        gameCtx.shadowColor = this.hit ? '#00ff66' : this.missed ? '#ff4444' : '#0096ff';
        
        // Note circle
        gameCtx.fillStyle = this.hit ? '#00ff66' : this.missed ? '#ff4444' : '#0096ff';
        gameCtx.beginPath();
        gameCtx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2);
        gameCtx.fill();
        
        // Note name
        gameCtx.shadowBlur = 0;
        gameCtx.fillStyle = '#000';
        gameCtx.font = 'bold 16px Syne Mono';
        gameCtx.textAlign = 'center';
        gameCtx.textBaseline = 'middle';
        gameCtx.fillText(this.noteName, this.x, this.y);
        
        gameCtx.restore();
      }
      
      onHit() {
        this.hit = true;
        state.hits++;
        updateStats();
        showFeedback('hit', this.noteName);
      }
    }
    
    // Sensitivity system
    function updateSensitivity(val) {
      micState.rmsThreshold = 0.20 - (val / 100) * 0.19;
      $('sensitivityValue').textContent = val;
    }
    
    $('sensitivity').addEventListener('input', e => updateSensitivity(e.target.value));
    updateSensitivity(50);
    
    // Microphone setup
    async function setupMic() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        if (!state.audioCtx) {
          state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        micState.analyzer = state.audioCtx.createAnalyser();
        micState.analyzer.fftSize = 4096;
        const source = state.audioCtx.createMediaStreamSource(stream);
        source.connect(micState.analyzer);
        micState.enabled = true;
        
        detectPitch();
      } catch (err) {
        console.error('Mic setup failed:', err);
      }
    }
    
    function detectPitch() {
      if (!micState.enabled || !micState.analyzer) {
        requestAnimationFrame(detectPitch);
        return;
      }
      
      const buffer = new Float32Array(micState.analyzer.fftSize);
      micState.analyzer.getFloatTimeDomainData(buffer);
      
      // Update level meter
      let rms = 0;
      for (let i = 0; i < buffer.length; i++) rms += buffer[i] * buffer[i];
      rms = Math.sqrt(rms / buffer.length);
      const levelPct = Math.min(100, (rms / 0.3) * 100);
      const levelFill = $('levelFill');
      if (levelFill) levelFill.style.width = levelPct + '%';
      
      // Basic pitch detection (simplified)
      if (rms > micState.rmsThreshold) {
        // Find the note in trigger zone and mark as hit
        const playBarY = gameCanvas.height / 2;
        state.notes.forEach(note => {
          if (!note.hit && !note.missed && Math.abs(note.y - playBarY) < 50) {
            note.onHit();
          }
        });
      }
      
      requestAnimationFrame(detectPitch);
    }
    
    function updateStats() {
      $('hits').textContent = state.hits;
      $('misses').textContent = state.misses;
      const total = state.hits + state.misses;
      $('accuracy').textContent = total > 0 ? Math.round((state.hits / total) * 100) + '%' : '--%';
    }
    
    function showFeedback(type, note) {
      const feedback = $('note-feedback');
      feedback.className = `note-feedback ${type}`;
      feedback.textContent = type === 'hit' ? `üé∏ ${note} ‚úì` : `üé∏ ${note} ‚úó`;
      
      setTimeout(() => {
        feedback.className = 'note-feedback';
        feedback.textContent = 'üé∏ --';
      }, 1000);
    }
    
    function generateScale() {
      const root = parseInt($('root-note').value);
      const scaleType = $('scale-type').value;
      const intervals = SCALES[scaleType];
      
      state.scale = intervals.map(interval => {
        const noteIndex = (root + interval) % 12;
        return NOTE_NAMES[noteIndex];
      });
    }
    
    function spawnNote() {
      if (!state.running || state.paused) return;
      
      generateScale();
      const randomNote = state.scale[Math.floor(Math.random() * state.scale.length)];
      state.notes.push(new FallingNote(randomNote, 0));
    }
    
    function updateBeat() {
      const beatInterval = (60 / state.bpm) * 1000; // ms per beat
      const now = performance.now();
      
      if (now - state.lastBeatTime >= beatInterval) {
        state.currentBeat = (state.currentBeat % state.timeSignature) + 1;
        state.lastBeatTime = now;
        
        // Update beat display
        $('current-beat').textContent = state.currentBeat;
        const beatDots = document.querySelectorAll('.beat-dot');
        beatDots.forEach((dot, i) => {
          dot.classList.toggle('active', i === state.currentBeat - 1);
        });
        
        // Metronome sound
        if ($('metronome').checked) {
          playMetronome(state.currentBeat === 1);
        }
        
        // Spawn note on downbeat
        if (state.currentBeat === 1) {
          spawnNote();
        }
      }
    }
    
    function playMetronome(isDownbeat) {
      if (!state.audioCtx) return;
      
      const osc = state.audioCtx.createOscillator();
      const gain = state.audioCtx.createGain();
      osc.connect(gain);
      gain.connect(state.audioCtx.destination);
      
      osc.frequency.value = isDownbeat ? 1000 : 800;
      osc.type = 'square';
      gain.gain.setValueAtTime(0.1, state.audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime + 0.1);
      
      osc.start();
      osc.stop(state.audioCtx.currentTime + 0.1);
    }
    
    let lastTime = 0;
    function gameLoop(currentTime) {
      if (!state.running || state.paused) {
        if (state.running) requestAnimationFrame(gameLoop);
        return;
      }
      
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;
      
      // Update beat timing
      updateBeat();
      
      // Update notes
      state.notes = state.notes.filter(note => note.update(deltaTime));
      
      // Draw math animation
      drawMathAnimation();
      
      // Draw game elements
      if (gameCtx) {
        gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        state.notes.forEach(note => note.draw());
      }
      
      requestAnimationFrame(gameLoop);
    }
    
    // Control functions
    function start() {
      if (!state.audioCtx) {
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      state.running = true;
      state.paused = false;
      state.bpm = parseInt($('bpm').value);
      state.timeSignature = parseInt($('time-sig').value);
      state.startTime = performance.now();
      state.lastBeatTime = performance.now();
      state.currentBeat = 0;
      
      $('start-btn').style.display = 'none';
      $('pause-btn').style.display = 'block';
      $('stop-btn').style.display = 'block';
      
      // Disable settings
      document.querySelectorAll('.settings-panel select, .settings-panel input[type=number]').forEach(el => el.disabled = true);
      
      setupMic();
      requestAnimationFrame(gameLoop);
    }
    
    function pause() {
      state.paused = !state.paused;
      $('pause-btn').textContent = state.paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
    }
    
    function stop() {
      state.running = false;
      state.paused = false;
      state.notes = [];
      state.hits = 0;
      state.misses = 0;
      state.currentBeat = 0;
      
      $('start-btn').style.display = 'block';
      $('pause-btn').style.display = 'none';
      $('stop-btn').style.display = 'none';
      $('pause-btn').textContent = '‚è∏ Pause';
      
      // Enable settings
      document.querySelectorAll('.settings-panel select, .settings-panel input[type=number]').forEach(el => el.disabled = false);
      
      updateStats();
      
      // Clear canvases
      if (gameCtx) gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    }
    
    // Event listeners
    $('start-btn').onclick = start;
    $('pause-btn').onclick = pause;
    $('stop-btn').onclick = stop;
    
    $('bpm').addEventListener('input', (e) => {
      state.bpm = parseInt(e.target.value);
      $('current-bpm').textContent = state.bpm;
      $('bpm-number').textContent = state.bpm;
    });
    
    // Initialize
    window.addEventListener('load', () => {
      initCanvases();
      updateStats();
      
      // Start math animation immediately
      function mathLoop() {
        drawMathAnimation();
        requestAnimationFrame(mathLoop);
      }
      mathLoop();
    });
  </script>
</body>
</html>